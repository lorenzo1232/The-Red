<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>The Red — Feed</title>
<style>
  body{margin:0;background:#000;color:#fff;font-family:system-ui,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;overflow:hidden}
  .feed-container{height:100vh;overflow-y:scroll;scroll-snap-type:y mandatory;padding-left:env(safe-area-inset-left,0)}
  .video-container{position:relative;z-index:0;height:100vh;scroll-snap-align:start}
  video{width:100%;height:100%;object-fit:cover;display:block}

  /* Left actions */
  .video-actions{
    position:absolute;left:calc(15px + env(safe-area-inset-left,0px));bottom:140px;
    display:flex;flex-direction:column;gap:14px;align-items:center;
    z-index:10000;pointer-events:auto;filter:drop-shadow(0 0 10px rgba(255,0,0,.15));
  }
  .action-btn{
    background:rgba(10,10,10,.65);backdrop-filter:blur(6px);border:1px solid #1f1f1f;
    width:52px;height:52px;border-radius:16px;display:grid;place-items:center;cursor:pointer;
    transition:transform .15s ease, box-shadow .2s ease, filter .2s ease; padding:0;
  }
  .action-btn:active{transform:scale(.96)}
  .action-btn img{width:26px;height:26px;display:block}
  .action-btn:hover,.action-btn:active{transform:scale(1.06);box-shadow:0 0 18px rgba(255,0,0,.35)}
  .action-btn:hover img,.action-btn:active img{filter:drop-shadow(0 0 10px rgba(255,0,0,.8))}
  .action-btn.on img{filter:drop-shadow(0 0 12px rgba(255,0,0,1));transform:scale(1.08)}
  .action-count{font-size:12px;color:#cfcfcf;text-align:center;margin-top:4px}

  /* Right info */
  .video-info-right{position:absolute;bottom:120px;right:15px;text-align:right;z-index:10;text-shadow:0 0 5px #000;max-width:60%}
  .video-info-right .user{font-weight:700;font-size:16px;margin-bottom:5px}
  .video-info-right .description{font-size:14px;opacity:.9}

  /* Seek bar */
  .seek-wrap{position:absolute;left:15px;right:15px;bottom:60px;height:18px;display:flex;align-items:center;gap:8px;z-index:12}
  .seek{position:relative;flex:1;height:6px;border-radius:6px;background:rgba(255,255,255,.15);overflow:hidden;cursor:pointer;backdrop-filter:blur(2px)}
  .seek .fill{position:absolute;left:0;top:0;bottom:0;width:0%;background:#ff2b2b;box-shadow:0 0 10px rgba(255,0,0,.35)}
  .seek .thumb{position:absolute;top:50%;transform:translate(-50%,-50%);width:12px;height:12px;border-radius:50%;background:#fff;box-shadow:0 0 10px rgba(255,0,0,.45)}
  .time{font:12px/1.2 system-ui,sans-serif;color:#ddd;min-width:68px;text-align:right;text-shadow:0 0 4px rgba(0,0,0,.7)}

  /* Header */
  .header{position:absolute;top:60px;left:0;right:0;z-index:20;display:flex;align-items:center;justify-content:space-between;padding:0 16px}
  .logo-text{font-size:20px;font-weight:800;color:#ff2b2b;letter-spacing:.8px}
  .followers-chip{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:14px;box-shadow:0 0 12px rgba(255,0,0,.18)}
  .followers-count{color:#ff2b2b;font-weight:700}
  .search-btn{display:grid;place-items:center;width:36px;height:36px;border-radius:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);cursor:pointer}
  .search-btn img{width:18px;height:18px}

  /* Search overlay */
  .search-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:30}
  .search-card{width:min(680px,92vw);background:#0f0f0f;border:1px solid #1f1f1f;border-radius:16px;padding:14px;box-shadow:0 0 40px rgba(255,0,0,.18)}
  .search-row{display:flex;gap:8px}
  .search-input{flex:1;padding:12px;border-radius:12px;background:#0a0a0a;color:#fff;border:1px solid #222;outline:none;font-size:14px}
  .search-close{padding:0 12px;border-radius:12px;background:#1b1b1b;color:#fff;border:1px solid #333;cursor:pointer}
  .search-hint{color:#aaa;font-size:12px;margin-top:8px}

  /* Bottom nav (smaller icons) */
  .bottom-nav{position:fixed;bottom:0;width:100%;height:60px;background:rgba(0,0,0,.7);display:flex;justify-content:space-around;align-items:center;z-index:15}
  .nav-item{text-align:center;color:#fff;font-size:14px;position:relative}
  .nav-icon-img{width:20px;height:20px;display:block;margin:0 auto}
  .nav-text{display:block;margin-top:2px;font-size:12px;opacity:.9}
  .badge{position:absolute;top:-5px;right:10px;background:#ff2b2b;color:#fff;border-radius:50%;padding:2px 6px;font-size:10px;font-weight:700;box-shadow:0 0 8px rgba(255,0,0,.35)}

  /* Record FAB */
  .record-fab{position:fixed;left:50%;bottom:72px;transform:translateX(-50%);width:82px;height:82px;z-index:100;display:grid;place-items:center}
  .rec-ring{position:absolute;inset:0;border-radius:50%;background:radial-gradient(60% 60% at 50% 50%,rgba(255,0,0,.18),rgba(255,0,0,.06) 60%,rgba(0,0,0,0) 61%);animation:ringPulse 2.2s ease-in-out infinite}
  .rec-btn{width:68px;height:68px;border-radius:50%;background:#ff2b2b;border:2px solid #2a2a2a;box-shadow:0 0 28px rgba(255,0,0,.45),inset 0 0 10px rgba(255,255,255,.15);display:grid;place-items:center;cursor:pointer}
  .rec-dot{width:18px;height:18px;border-radius:4px;background:#fff;animation:recPulse 1.2s ease-in-out infinite}
  @keyframes recPulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(.7);opacity:.85}}
  @keyframes ringPulse{0%,100%{transform:scale(1);opacity:.8}50%{transform:scale(1.08);opacity:1}}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="followers-chip">Followers <span class="followers-count" id="followersCount">0</span></div>
  <div class="logo-text">THE RED</div>
  <button class="search-btn" id="openSearch"><img src="assets/icons/search.png" alt="Search"></button>
</div>

<!-- Search overlay -->
<div class="search-overlay" id="searchOverlay">
  <div class="search-card">
    <div class="search-row">
      <input id="searchInput" class="search-input" placeholder="Search by user or caption…"/>
      <button class="search-close" id="closeSearch">Close</button>
    </div>
    <div class="search-hint">Tip: type @username or any word from the caption.</div>
  </div>
</div>

<!-- Feed -->
<div class="feed-container" id="feedContainer"></div>

<!-- Record FAB -->
<div class="record-fab">
  <div class="rec-ring"></div>
  <div class="rec-btn" onclick="recordVideo()"><div class="rec-dot"></div></div>
</div>

<!-- Bottom nav -->
<div class="bottom-nav">
  <div class="nav-item"><img class="nav-icon-img" src="assets/icons/home.png" alt="Home"><span class="nav-text">Home</span></div>
  <div class="nav-item"><img class="nav-icon-img" src="assets/icons/friends.png" alt="Friends"><span class="badge">55</span><span class="nav-text">Friends</span></div>
  <div class="nav-item"></div>
  <div class="nav-item"><img class="nav-icon-img" src="assets/icons/inbox.png" alt="Inbox"><span class="badge">11</span><span class="nav-text">Inbox</span></div>
  <div class="nav-item"><img class="nav-icon-img" src="assets/icons/profile.png" alt="Profile"><span class="nav-text">Profile</span></div>
</div>

<!-- Firebase + logic (WITH real-time likes) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, collection, getDocs, doc, getDoc, setDoc, deleteDoc,
    onSnapshot, runTransaction, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCK3buy-uDODEUEbfANKz5V7UOdw_Iubws",
    authDomain: "the-red-6d1f8.firebaseapp.com",
    projectId: "the-red-6d1f8",
    storageBucket: "the-red-6d1f8.appspot.com",
    messagingSenderId: "720944313823",
    appId: "1:720944313823:web:4cb2acd48dfb173c6c806a"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  await signInAnonymously(auth).catch(console.error);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // Followers (demo; adjust path if you store per-user)
  async function loadFollowers(){
    try{
      const snap = await getDocs(collection(db, "followers"));
      const el = document.getElementById('followersCount');
      if (el) el.textContent = snap.size.toLocaleString();
    }catch(e){ console.warn('Followers failed:', e.message); }
  }

  async function resolveVideoURL(data){
    if(data.url) return data.url;
    if(data.storagePath){
      try { return await getDownloadURL(ref(storage, data.storagePath)); }
      catch(e){ console.error('getDownloadURL:', e.message, data.storagePath); }
    }
    return null;
  }

  const fmtTime = t => !isFinite(t) ? "0:00" : `${Math.floor(t/60)}:${String(Math.floor(t%60)).padStart(2,'0')}`;

  // ---- Likes: live counts + transactional toggle ----
  function subscribeCounts(videoId, likeCountEl, cmtCountEl){
    const vRef = doc(db, "videos", videoId);
    return onSnapshot(vRef, snap=>{
      const d = snap.data(); if(!d) return;
      if (likeCountEl) likeCountEl.textContent = (d.likesCount ?? 0).toLocaleString();
      if (cmtCountEl)  cmtCountEl.textContent  = (d.commentsCount ?? 0).toLocaleString();
    });
  }

  async function ensureLikeState(videoId, btn){
    const uid = auth.currentUser?.uid; if(!uid) return;
    const likeRef = doc(db, "videos", videoId, "likes", uid);
    const liked = (await getDoc(likeRef)).exists();
    btn.classList.toggle('on', liked);
  }

  async function toggleLike(videoId, btn){
    const uid = auth.currentUser?.uid; if(!uid) return;
    const vRef = doc(db, "videos", videoId);
    const likeRef = doc(db, "videos", videoId, "likes", uid);

    try{
      await runTransaction(db, async tx=>{
        const vSnap = await tx.get(vRef);
        if(!vSnap.exists()) return;

        const liked = (await tx.get(likeRef)).exists();
        let count = vSnap.data().likesCount || 0;

        if(liked){
          tx.delete(likeRef);
          count = Math.max(0, count - 1);
        }else{
          tx.set(likeRef, { uid, createdAt: serverTimestamp() });
          count = count + 1;
        }
        tx.update(vRef, { likesCount: count });
      });
      btn.classList.toggle('on');
    }catch(err){
      console.error('toggleLike:', err);
    }
  }
  // ---------------------------------------------------

  // Search UI
  const overlay = document.getElementById('searchOverlay');
  document.getElementById('openSearch')?.addEventListener('click', ()=>{
    overlay.style.display='flex'; document.getElementById('searchInput').focus();
  });
  document.getElementById('closeSearch')?.addEventListener('click', ()=>{
    overlay.style.display='none'; document.getElementById('searchInput').value=''; applyFilter('');
  });
  document.getElementById('searchInput')?.addEventListener('input', (e)=> applyFilter(e.target.value));

  let allCards = [];
  function applyFilter(q){
    const k = (q||'').trim().toLowerCase();
    for(const {el, data} of allCards){
      const hay = (data.username || data.user || '').toLowerCase();
      const cap = (data.description || data.caption || '').toLowerCase();
      const show = !k || hay.includes(k) || cap.includes(k) || (k.startsWith('@') && ('@'+hay).includes(k));
      el.style.display = show ? '' : 'none';
    }
  }

  async function loadVideos(){
    const feed = document.getElementById('feedContainer');
    const snap = await getDocs(collection(db, "videos"));
    if(snap.empty){
      feed.innerHTML = `<p style="color:#fff;text-align:center;margin-top:50%;">⚠️ No videos yet in 'videos'.</p>`;
      return;
    }

    for(const d of snap.docs){
      const data = d.data();
      const url = await resolveVideoURL(data);
      if(!url){ console.warn('Doc without URL:', d.id); continue; }

      const card = document.createElement('div');
      card.className = 'video-container';
      card.innerHTML = `
        <video src="${url}" autoplay loop muted playsinline></video>
        <div class="video-info-right">
          <div class="user">@${data.username || data.user || "user"}</div>
          <div class="description">${data.description || data.caption || "Video description"}</div>
        </div>
      `;

      // Left actions
      const actions = document.createElement('div'); actions.className = 'video-actions';

      const likeBtn = document.createElement('button'); likeBtn.className='action-btn';
      likeBtn.innerHTML = '<img src="assets/icons/love.png" alt="like">';
      const likeCount = document.createElement('div'); likeCount.className='action-count'; likeCount.textContent=(data.likesCount ?? 0).toLocaleString();

      const cmtBtn = document.createElement('button'); cmtBtn.className='action-btn';
      cmtBtn.innerHTML = '<img src="assets/icons/comments.png" alt="comments">';
      const cmtCount = document.createElement('div'); cmtCount.className='action-count'; cmtCount.textContent=(data.commentsCount ?? 0).toLocaleString();

      const favBtn = document.createElement('button'); favBtn.className='action-btn';
      favBtn.innerHTML = '<img src="assets/icons/favorites.png" alt="favorites">';
      const favLbl = document.createElement('div'); favLbl.className='action-count'; favLbl.textContent='Save';

      const shareBtn = document.createElement('button'); shareBtn.className='action-btn';
      shareBtn.innerHTML = '<img src="assets/icons/share.png" alt="share">';
      const shareLbl = document.createElement('div'); shareLbl.className='action-count'; shareLbl.textContent='Share';

      actions.append(likeBtn, likeCount, cmtBtn, cmtCount, favBtn, favLbl, shareBtn, shareLbl);
      card.appendChild(actions);

      // Like interactions
      await ensureLikeState(d.id, likeBtn);
      likeBtn.addEventListener('click', ()=> toggleLike(d.id, likeBtn));
      subscribeCounts(d.id, likeCount, cmtCount); // live updates

      // Seek bar
      const videoEl = card.querySelector('video');
      const seekWrap = document.createElement('div'); seekWrap.className = 'seek-wrap';
      const seek = document.createElement('div'); seek.className = 'seek';
      const fill = document.createElement('div'); fill.className = 'fill';
      const thumb = document.createElement('div'); thumb.className = 'thumb';
      seek.append(fill, thumb);
      const time = document.createElement('div'); time.className = 'time'; time.textContent = '0:00 / 0:00';
      seekWrap.append(seek, time); card.appendChild(seekWrap);

      function syncSeek(){ if(!videoEl.duration) return; const p=(videoEl.currentTime/videoEl.duration)*100; fill.style.width=p+'%'; thumb.style.left=p+'%'; time.textContent=`${fmtTime(videoEl.currentTime)} / ${fmtTime(videoEl.duration)}`; }
      videoEl.addEventListener('timeupdate', syncSeek);
      videoEl.addEventListener('loadedmetadata', syncSeek);

      let dragging=false, wasPlaying=false;
      const pctFrom = e => { const r=seek.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left; return Math.min(1,Math.max(0,x/r.width)); };
      const seekTo = e => { if(!videoEl.duration) return; const p=pctFrom(e); videoEl.currentTime=p*videoEl.duration; syncSeek(); };
      seek.addEventListener('mousedown', e=>{dragging=true;wasPlaying=!videoEl.paused;videoEl.pause();seekTo(e);});
      window.addEventListener('mousemove', e=>{if(dragging) seekTo(e);});
      window.addEventListener('mouseup', ()=>{if(dragging){dragging=false;if(wasPlaying) videoEl.play();}});
      seek.addEventListener('touchstart', e=>{dragging=true;wasPlaying=!videoEl.paused;videoEl.pause();seekTo(e);},{passive:true});
      window.addEventListener('touchmove', e=>{if(dragging) seekTo(e);},{passive:true});
      window.addEventListener('touchend', ()=>{if(dragging){dragging=false;if(wasPlaying) videoEl.play();}});

      document.getElementById('feedContainer').appendChild(card);
      allCards.push({el:card, data});
    }
  }

  // Record button
  window.recordVideo = () => window.location.href = 'record.html';

  // Init
  window.addEventListener('DOMContentLoaded', async ()=>{
    await loadFollowers();
    await loadVideos();
  });
</script>
</body>
</html>
